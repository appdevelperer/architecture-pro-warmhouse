# Project_template

# Задание 1. Анализ и планирование

### 1. Описание функциональности монолитного приложения

**Управление отоплением:**

- Пользователи могут удалённо включать/выключать отопление в своих домах.
- Система поддерживает синхронный запрос к удаленному датчику для получения информации о его состоянии и его изменении

**Мониторинг температуры:**

- Пользователи могут просматривать текущую температуру в своих домах через веб-интерфейс.
- Система получает данные о температуре с датчиков, установленных в домах.

### 2. Анализ архитектуры монолитного приложения

    Язык программирования: Go
    База данных: PostgreSQL
    Архитектура: Монолитная, все компоненты системы (обработка запросов, бизнес-логика, работа с данными) находятся в рамках одного приложения.
    Взаимодействие: Синхронное, запросы обрабатываются последовательно.
    Масштабируемость: Ограничена, так как монолит сложно масштабировать по частям.
    Развертывание: Требует остановки всего приложения.

### 3. Определение доменов и границы контекстов (в скобках язык контекста)

    Управление устройствами — взаимодействие с датчиками, реле, камерами, воротами и т.д. (Устройство, Датчик, Реле, Камера, Ворота, Статус, Команда)
    Управление сценариями — создание, редактирование, выполнение автоматизированных правил (например: “если температура < 18°C — включить отопление”). (Сценарий, Триггер, Действие, Условие, Расписание)
    Управление пользователями и доступом — регистрация, аутентификация, авторизация, профили. (Пользователь, Аккаунт, Роль, Сессия, Аутентификация)
    Продажа и конфигурация комплектов (SaaS)— выбор, покупка, активация модулей умного дома. (Комплект, Модуль, Заказ, Активация, Партнёрский продукт)
    Телеметрия и мониторинг — сбор, хранение, отображение данных с устройств (температура, статус света, положение ворот и т.п.). (Телеметрия, Показатель, История, График, Оповещение)
    Поддержка партнёрских устройств — интеграция с устройствами сторонних производителей по стандартным протоколам. (Протокол, Адаптер, Шлюз, MQTT, HTTP, Zigbee (в реализации))
	
### **4. Проблемы монолитного решения**

- Отсутствие масштабируемости 
Система синхронная, монолитная — чтобы справиться с ростом (от 100 до тысяч домов), нужно масштабировать весь монолит целиком, даже если нагрузка растёт только на одну функцию 
- Жёсткая связанность
Всё — управление отоплением, пользователи, телеметрия, команды — “сварено” в одном коде. Добавить поддержку света, ворот или камер — значит лезть в ядро монолита
- Невозможность подключения устройств партнёров 
Система заточена под собственные датчики с проприетарным протоколом. Подключить устройства других производителей — технически невозможно без полного рефакторинга. 
- Проблемы с командной разработкой, невозможность параллельной разработки
- Сложность тестирования - нужно тестировать всю систему вместо того, чтобы покрыть тестами 1 или несколько изолированных микросервисов
- Нет самообслуживания — зависимость от специалистов
- Синхронный опрос устройств
- PostgreSQL как универсальное хранилище

### 5. Визуализация контекста системы — диаграмма С4 

c4_ContextDiagram_AsIs.plantuml (см. проект warmHouse.Analisys)

# Задание 2. Проектирование микросервисной архитектуры

**Диаграмма контекста To-Be (Context)**

c4_ContextDiagram_ToBe.plantuml (см. проект warmHouse.Analisys)

**Диаграмма контейнеров (Containers)**

с4_ContainerDiagram.plantuml (см. проект warmHouse.Analisys)

**Диаграмма компонентов (Components)**

c4_ComponentDiagram_DeviceManagement.plantuml (см. проект warmHouse.Analisys)
c4_ComponentDiagram_ScenarioManagement.plantuml (см. проект warmHouse.Analisys)

**Диаграмма кода (Code)**

c4_CodeDiagram.plantuml (см. проект warmHouse.Analisys)

# Задание 3. Разработка ER-диаграммы

ER_diagram.plantuml (см. проект warmHouse.Analisys)

# Задание 4. Создание и документирование API

### 1. Тип API

Для взаимодействия я буду использовать:
- REST для синхронного взаимодействия в тех случаях, когда важна скорость и непрерывность операции (например, связка Пользовательский интерфейс - Бэкенд, Синхронные операции с подтверждением, например, отправка команд устройствам, а также финансовые операции) либо для предоставляения API для внешних пользователей
- RMQ для асинхронного взаимодейтсвия в тех случаях, когда не требуется того, что имеет REST. но требуется гарантированная доставка и повторные попытки, слабление связности сервисов, либо в случае высокой нагрузки

Детали для выбранного сервиса в DeviceManagerService.yaml (см. проект warmHouse.Analisys)

### 2. Документация API

DeviceManagerService.yaml (для swagger) (см. проект warmHouse.Analisys)

# Задание 5. Работа с docker и docker-compose

Создан workspace, в рамках которого есть несколько проектов-решений:
1) WarmHouse.Analisys - содержит ReadMe, диаграмы c4, ER-диаграма, пример описания API 

2) WarmHouse.SensorService - содержит мок-сервис датчика температур. 
БУдет доступен после запуска по http://localhost:8081/swagger/index.html

3) WarmHouse.Monolit - содержит приложение-монолит для работы с датчиками температуры. Для него прежний docker compose был расширен: в него добавен сервис WarmHouse.SensorService, а также pgadmin. 
После запуска можно увидеть температуру, которую передает датчик по http://localhost:8080/api/v1/sensors/temperature/Living%20Room

4) WarmHouse.DeviceManagerService - содержит сервис управления устройствами. Предполагается, что монолит будет не самостоятельно работать с устройствами, а будет использовать этот сервис. 
API Swagger сервиса будет достепeн через http://localhost:8300/swagger/index.html. 
При выполнении операции Command через API команда будет передана устройству и будет сформировано сообщение в RMQ и отправлено в exchange telemetry.events

5) WarmHouse.TelemetryService - содержит сервис телеметрии, обрабатывающий соообщения из rmq и записывающий его в БД. 


Для запуска нужно выполнить ./init.sh в папке /app проекта.
После запуска будет доступны:
- RMQ GUI http://localhost:15673/
- Swagger мок-снрвиса устройства http://localhost:8081/swagger/index.html
- Swagger DeviceManagerService http://localhost:8300/swagger/index.html 
- PGadmin http://localhost:8201/login 
    - регистрируем сервер smarthome-postgres:5432 DB: smarthome, USER postgres, PWD: postgres
    - регистрируем сервер device-management-postgres:5432 DB: devicedb, USER postgres, PWD: postgres
    - регистрируем сервер device-management-postgres:5432 DB: devicedb, USER postgres, PWD: postgres
        
# **Задание 6. Разработка MVP**

4 и 5 пункты предыдущего раздела и будет MVP

Предполагается, что монолит (а в будущем ядро решения) не будет работать напрямую с устройствами. Вместо этого реализуется сервис DeviceManagerService, который:
    - принимает запросы на rest API
    - умеет опрашивать устройства
    - умеет управлять устройствами
    - умеет ииформировать о работе с устройствами другие сервисы через отправку сообщений в RMQ
    - умеет сохранять информацию об устройствах в свою БД

Предполагается также, что вся телеметрия будет управляться сервисом телеметрии, который:
    - умеет получать телеметрически данные из rmq
    - умеет обрабатывать и хранить данные в своей БД

Таким обазом, если при помощи Swagger DeviceManagerService http://localhost:8300/swagger/index.html добавить устройство, а затем вызывать метод command и передать ему "on" или "off", то мы увидим, что в БД телеметрии появится запись об этом событии.

Подключить сервис DeviceManagerService к монолиту сам быстро не смогу - нет опыта в работе с go